<div class="table-header">
  <h1>Danh sách Đơn hàng</h1>
  
  <div class="filters">
    <select (change)="onStoreChange($event)">
      <option value="">-- Lọc theo Thương hiệu --</option>
      @for(store of stores; track store.id) {
        <option [value]="store.id">{{ store.name }}</option>
      }
    </select>

    <select (change)="onBranchChange($event)" [disabled]="!selectedStoreId">
      <option value="">-- Lọc theo Chi nhánh --</option>
      @for(branch of branches; track branch.id) {
        <option [value]="branch.id">{{ branch.name }}</option>
      }
    </select>

    <select (change)="onTableChange($event)" [disabled]="!selectedBranchId">
        <option value="">-- Lọc theo Bàn --</option>
        @for(table of tablesForFilter; track table.id) {
          <option [value]="table.id">{{ table.name }}</option>
        }
    </select>
  </div>
</div>

<table class="data-table">
  <thead>
    <tr>
      <th>ID</th>
      <th>Bàn</th>
      <th>Thời gian</th>
      <th>Tổng tiền</th>
      <th>Trạng thái</th>
      <th>Hành động</th>
    </tr>
  </thead>
<tbody>
    @for (order of orders; track order.id) {
      <tr [class.highlight]="order.id === newOrderId"
      [class.payment-request]="order.id === paymentRequestId">
        <td>{{ order.id }}</td>
        <td>{{ order.tableName }}</td>
        <td>{{ order.orderTime | date:'dd/MM/yyyy HH:mm' }}</td>
        <td>{{ order.totalAmount | number }} đ</td> <td>{{ order.status }}</td>
        <td>
          <button (click)="toggleDetails(order.id)" class="btn-edit">
            {{ expandedOrderId === order.id ? 'Đóng' : 'Chi tiết' }}
          </button>
          @if (order.status === 'Pending') {
                <button (click)="completeOrder(order)" class="btn-complete">Hoàn thành</button>
            }
          <button (click)="deleteOrder(order.id)" class="btn-delete">Xóa</button>
        </td>
      </tr>
      @if (expandedOrderId === order.id) {
        <tr class="details-row">
            <td [attr.colspan]="6">
                <div class="details-container">
                    <h4>Các sản phẩm trong đơn hàng #{{ order.id }}</h4>
                    <table class="detail-table">
                        <thead>
                            <tr>
                                <th>Tên sản phẩm</th>
                                <th>Số lượng</th>
                                <th>Đơn giá</th>
                                <th>Thành tiền</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for(item of order.items; track item.productId) {
                            <tr>
                                <td>{{ item.productName }}</td>
                                <td>{{ item.quantity }}</td>
                                <td>{{ item.price | number }} đ</td>
                                <td>{{ (item.quantity * item.price) | number }} đ</td>
                            </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </td>
        </tr>
      }
    } @empty {
      <tr>
        <td colspan="6">Không có dữ liệu</td>
      </tr>
    }
</tbody>
</table>

<div class="pagination-controls">
  <button (click)="loadOrders(currentPage - 1)" [disabled]="currentPage === 1">Trước</button>
  <span>Trang {{ currentPage }} / {{ totalPages }} (Tổng số: {{ totalCount }})</span>
  <button (click)="loadOrders(currentPage + 1)" [disabled]="currentPage === totalPages">Sau</button>
</div>